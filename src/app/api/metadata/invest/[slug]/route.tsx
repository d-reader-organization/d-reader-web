import { join } from 'node:path'
import { readFile } from 'node:fs/promises'
import { ImageResponse } from 'next/og'
import { METADATA_IMAGE_SIZE } from '@/constants/general'
import { fetchCampaign } from '@/app/lib/api/campaign/queries'

export async function GET(request: Request, props: { params: Promise<{ slug: string }> }) {
  const params = await props.params
  const project = (await fetchCampaign(params.slug)).data

  let bannerSrc = project?.banner

  if (bannerSrc?.includes('assets')) {
    const imagePath = join(process.cwd(), 'public', bannerSrc ?? '/assets/images/metadata/metadata-invest.png')
    const bannerData = await readFile(imagePath)
    const extension = bannerSrc.split('.')[1] === 'png' ? 'png' : 'jpeg'
    bannerSrc = `data:image/${extension};base64,${bannerData.toString('base64')}`
  }

  return new ImageResponse(
    (
      <div
        style={{
          fontSize: 48,
          backgroundColor: '#15171c',
          width: '100%',
          height: '100%',
          display: 'flex',
          alignItems: 'center',
          justifyContent: 'center',
          color: 'white',
        }}
      >
        <img
          alt='Banner src'
          src={bannerSrc}
          style={{
            width: '100%',
            height: '100%',
            objectFit: 'fill',
          }}
        />
        <div
          style={{
            position: 'absolute',
            top: 0,
            left: 0,
            right: 0,
            bottom: 0,
            background:
              'linear-gradient(261deg, rgba(21, 23, 28, 0.00) 1.31%, rgba(21, 23, 28, 0.50) 49.87%, rgba(21, 23, 28, 0.89) 64.59%, #15171C 78.4%)',
          }}
        />
        <Logo />
        <p
          style={{
            position: 'absolute',
            left: 60,
            bottom: 100,
            fontSize: '56px',
            fontWeight: 600,
            lineHeight: 1.2,
            color: 'white',
            width: '50%',
          }}
        >
          {project?.title}
        </p>
      </div>
    ),
    METADATA_IMAGE_SIZE
  )
}

const Logo = () => (
  <svg
    xmlns='http://www.w3.org/2000/svg'
    width='199'
    height='58'
    viewBox='0 0 199 58'
    fill='none'
    style={{ position: 'absolute', top: 80, left: 60 }}
  >
    <path
      d='M74.46 35.8833C74.46 39.2125 74.5542 42.8732 74.6973 46.6317C72.0836 47.7728 69.3231 48.4394 65.4704 48.4394C56.9101 48.4394 52.3945 43.4946 52.3945 29.1797C52.3945 16.3411 57.1963 11.8218 65.9487 11.8218C69.7072 11.8218 72.5092 12.2963 75.1756 13.106C74.6031 15.6745 74.0344 18.3371 73.6051 20.9056C71.417 20.0507 68.7544 19.6703 66.7094 19.6703C62.0508 19.6703 59.8627 21.9036 59.8627 29.4659C59.8627 37.8831 61.8135 40.8771 65.5683 40.9261C66.2349 40.9261 66.9015 40.8771 67.5643 40.783C67.6133 38.4518 67.6132 35.7891 67.6132 33.4579C66.5663 33.4579 65.4741 33.5069 64.5703 33.5521C64.6192 32.4599 64.6192 31.413 64.6192 30.366C64.6192 29.319 64.6192 28.2268 64.5703 27.1799C66.2838 27.2288 67.8995 27.2288 69.5641 27.2288C71.2287 27.2288 72.8933 27.2288 74.509 27.1799C74.46 29.368 74.46 32.4599 74.46 35.8833Z'
      fill='white'
    />
    <path
      d='M97.0908 46.8197C94.5713 47.8177 91.5735 48.3901 88.3874 48.3901C80.682 48.3901 77.4507 43.9687 77.4507 33.1262C77.4507 21.1425 81.1113 17.3877 87.9618 17.3877C94.8123 17.3877 97.0456 20.4307 97.0456 28.6558C97.0456 31.2243 96.9025 34.0752 96.8084 35.077C94.6692 35.028 91.9087 35.028 89.4871 35.028H84.7795C85.0168 39.4494 86.301 40.9709 89.344 40.9709C91.9125 40.9709 93.7202 40.6395 96.0476 39.6377C96.2359 41.5886 96.7142 44.8688 97.0946 46.8197H97.0908ZM84.7757 31.0322C86.3914 31.0812 88.3422 31.0812 90.3383 31.0322C90.3872 30.2225 90.3872 29.2735 90.3872 28.0382C90.3872 24.2796 89.6754 23.3306 88.0108 23.3306C85.9658 23.3306 84.9189 24.8521 84.7757 31.036V31.0322Z'
      fill='white'
    />
    <path
      d='M113.26 47.9606C113.354 42.9216 113.354 36.4514 113.354 27.9401C113.354 25.7068 112.782 24.754 111.072 24.754C109.264 24.754 107.98 25.8951 107.98 29.1754C107.98 40.967 107.98 44.4393 108.029 47.9606H100.324C100.373 43.6334 100.418 39.5434 100.418 32.9339C100.418 26.3244 100.369 21.903 100.324 17.9072H108.074C108.025 19.3835 108.025 20.5247 107.98 21.8051L108.266 21.8541C109.456 18.8111 111.641 17.5269 114.733 17.5269C118.729 17.5269 120.962 19.6208 120.962 25.0892C120.962 31.032 120.913 33.9357 120.913 37.5474C120.913 41.4942 120.913 44.6803 121.007 47.9606H113.256H113.26Z'
      fill='white'
    />
    <path
      d='M143.364 46.8197C140.845 47.8177 137.847 48.3901 134.661 48.3901C126.955 48.3901 123.724 43.9687 123.724 33.1262C123.724 21.1425 127.385 17.3877 134.235 17.3877C141.086 17.3877 143.319 20.4307 143.319 28.6558C143.319 31.2243 143.176 34.0752 143.082 35.077C140.943 35.028 138.182 35.028 135.761 35.028H131.053C131.29 39.4494 132.574 40.9709 135.617 40.9709C138.186 40.9709 139.994 40.6395 142.321 39.6377C142.509 41.5886 142.988 44.8688 143.368 46.8197H143.364ZM131.049 31.0322C132.665 31.0812 134.616 31.0812 136.612 31.0322C136.661 30.2225 136.661 29.2735 136.661 28.0382C136.661 24.2796 135.949 23.3306 134.284 23.3306C132.239 23.3306 131.192 24.8521 131.049 31.036V31.0322Z'
      fill='white'
    />
    <path
      d='M155.343 17.4785C158.48 17.4785 161.572 18.002 163.711 18.7138C163.33 20.9471 163.093 23.3272 162.856 25.5605C161.048 24.7508 158.717 24.3705 156.815 24.3705C154.39 24.3705 153.58 25.2254 153.58 26.4154C153.58 26.9841 153.817 27.5566 154.341 28.08C154.913 28.6977 155.862 29.3153 157.003 29.933C159.048 30.931 160.901 32.0721 162.14 33.7367C163.33 35.2092 163.993 37.209 163.993 39.7285C163.993 45.4342 160.999 48.432 154.435 48.432C151.012 48.432 147.776 47.6712 145.588 46.8615C145.969 44.3872 146.255 41.7735 146.541 39.3971C148.537 40.301 150.82 40.9676 153.151 40.9676C155.482 40.9676 156.288 39.9206 156.288 38.6853C156.288 37.9246 156.002 37.2128 155.433 36.5914C154.766 35.8796 153.817 35.2582 152.578 34.5954C150.533 33.6426 148.775 32.5993 147.584 31.0778C146.492 29.6995 145.826 27.9859 145.826 25.5605C145.826 20.7588 148.963 17.4785 155.335 17.4785H155.343Z'
      fill='white'
    />
    <path
      d='M166.895 47.9611C166.989 43.4907 166.989 38.2596 166.989 32.4109C166.989 26.8936 166.94 22.2349 166.895 17.9077H174.646C174.502 22.2839 174.502 26.8484 174.502 32.7461C174.502 39.4987 174.502 43.6376 174.646 47.9648H166.895V47.9611Z'
      fill='white'
    />
    <path
      d='M187.198 17.4785C190.335 17.4785 193.427 18.002 195.566 18.7138C195.185 20.9471 194.948 23.3272 194.711 25.5605C192.903 24.7508 190.572 24.3705 188.67 24.3705C186.245 24.3705 185.435 25.2254 185.435 26.4154C185.435 26.9841 185.672 27.5566 186.196 28.08C186.768 28.6977 187.717 29.3153 188.858 29.933C190.903 30.931 192.756 32.0721 193.995 33.7367C195.185 35.2092 195.848 37.209 195.848 39.7285C195.848 45.4342 192.854 48.432 186.29 48.432C182.867 48.432 179.631 47.6712 177.443 46.8615C177.824 44.3872 178.11 41.7735 178.396 39.3971C180.392 40.301 182.674 40.9676 185.006 40.9676C187.337 40.9676 188.143 39.9206 188.143 38.6853C188.143 37.9246 187.857 37.2128 187.288 36.5914C186.621 35.8796 185.672 35.2582 184.433 34.5954C182.388 33.6426 180.629 32.5993 179.439 31.0778C178.347 29.6995 177.681 27.9859 177.681 25.5605C177.681 20.7588 180.818 17.4785 187.19 17.4785H187.198Z'
      fill='white'
    />
    <path
      d='M20.6994 1.97021C9.26556 1.97021 0.000976562 20.2056 0.000976562 35.2963C0.000976562 50.387 9.26932 56.6161 20.6994 56.6161C32.1295 56.6161 41.3978 50.387 41.3978 35.2963C41.3978 20.2056 32.1332 1.97021 20.6994 1.97021ZM12.2709 33.9518C12.2709 35.398 11.0996 36.5692 9.65346 36.5692C8.20728 36.5692 7.03604 35.398 7.03604 33.9518V23.9227C7.03604 22.4765 8.20728 21.3053 9.65346 21.3053C11.0996 21.3053 12.2709 22.4765 12.2709 23.9227V33.9518ZM26.8306 33.9518C26.8306 35.398 25.6593 36.5692 24.2132 36.5692C22.767 36.5692 21.5957 35.398 21.5957 33.9518V23.9227C21.5957 22.4765 22.767 21.3053 24.2132 21.3053C25.6593 21.3053 26.8306 22.4765 26.8306 23.9227V33.9518Z'
      fill='white'
    />
  </svg>
)
